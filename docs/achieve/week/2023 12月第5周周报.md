---
date: 2024-01-22
authors:
  - P1sc3s007
---
## 完成事项
- 安洵杯、NCTF力所能及的复盘
- Move CTF的基础学习
## 未完成事项

- d810 deflat工具研究控制流平坦化
- 你好PE
- NCTF复盘没搞完
## 如何解决未完成事项

- 期末考完再努力吧（笑）
## 下周待做事项

- d810 deflat工具研究控制流平坦化
- windbg内核调试学习
- babyre
- 研究PE_Loader（有空再说吧……）
- SM4，Blowfish、CRC64算法研究
## 本周学习的知识分享
### 一、Move CTF入门
详细的环境配置教程可以看探姬师傅的教程 <br />[从0开始的签到题 - Hello CTF](https://ctf.probius.xyz/HC_blockchain/Move/0x00/#_1)<br />我想记录一些常用命令，和报错的解决<br />用于测试的是Move CTF 2024的例题check in
#### 添加与切换试题网络（注意网址中不要有多余的空格，不然会报错）：
第一次进入：`sui client`<br />具体参数参考
```
> sui client

Config file ["/home/tj/.sui/sui_config/client.yaml"] doesn't exist, do you want to connect to a Sui Full node server [y/N]?y
Sui Full node server URL (Defaults to Sui Devnet if not specified) : https://fullnode.devnet.sui.io:443
Environment alias for [https://fullnode.devnet.sui.io:443] : moveCTF2024
Select key scheme to generate keypair (0 for ed25519, 1 for secp256k1, 2: for secp256r1):
0
Generated new keypair for address with scheme "ed25519" [0xcef64a585358ba722e0e1b860f11eb7e05eaf9347162ac6743c15cc0b60dd877]
Secret Recovery Phrase : [absent weird horn travel ghost polar jazz thank innocent funny cancel warfare]
Client for interacting with the Sui network
```
再次添加/切换网络
```
sui client new-env --alias <ALIAS> --rpc <RPC-SERVER-URL>
eg.> sui client new-env --alias moveCTF_demo --rpc https://fullnode.devnet.sui.io:443

sui client switch --env <ALIAS>
eg.> sui client switch --env moveCTF_demo
```
正常运行：
```
> sui client
Client for interacting with the Sui network

Usage: sui client [OPTIONS] [COMMAND]

Commands:
  active-address         Default address used for commands when none specified
  active-env             Default environment used for commands when none specified
  addresses              Obtain the Addresses managed by the client
  call                   Call Move function
  chain-identifier       Query the chain identifier from the rpc endpoint
  dynamic-field          Query a dynamic field by its address
  envs                   List all Sui environments
  execute-signed-tx      Execute a Signed Transaction. This is useful when the user prefers to sign elsewhere and
                             use this command to execute
  gas                    Obtain all gas objects owned by the address
  merge-coin             Merge two coin objects into one coin
  new-address            Generate new address and keypair with keypair scheme flag {ed25519 | secp256k1 | secp256r1}
                             with optional derivation path, default to m/44'/784'/0'/0'/0' for ed25519 or
                             m/54'/784'/0'/0/0 for secp256k1 or m/74'/784'/0'/0/0 for secp256r1. Word length can be {
                             word12 | word15 | word18 | word21 | word24} default to word12 if not specified
  new-env                Add new Sui environment
  object                 Get object info
  objects                Obtain all objects owned by the address
  pay                    Pay coins to recipients following specified amounts, with input coins. Length of recipients
                             must be the same as that of amounts
  pay-all-sui            Pay all residual SUI coins to the recipient with input coins, after deducting the gas cost.
                             The input coins also include the coin for gas payment, so no extra gas coin is required
  pay-sui                Pay SUI coins to recipients following following specified amounts, with input coins. Length
                             of recipients must be the same as that of amounts. The input coins also include the coin
                             for gas payment, so no extra gas coin is required
  publish                Publish Move modules
  split-coin             Split a coin object into multiple coins
  switch                 Switch active address and network(e.g., devnet, local rpc server)
  tx-block               Get the effects of executing the given transaction block
  transfer               Transfer object
  transfer-sui           Transfer SUI, and pay gas with the same SUI coin object. If amount is specified, only the
                             amount is transferred; otherwise the entire object is transferred
  upgrade                Upgrade Move modules
  verify-bytecode-meter  Run the bytecode verifier on the package
  verify-source          Verify local Move packages against on-chain packages, and optionally their dependencies
  replay-transaction     Replay a given transaction to view transaction effects. Set environment variable
                             MOVE_VM_STEP=1 to debug
  replay-batch           Replay transactions listed in a file
  replay-checkpoint      Replay all transactions in a range of checkpoints
  help                   Print this message or the help of the given subcommand(s)

Options:
      --client.config <CONFIG>  Sets the file storing the state of our user accounts (an empty one will be created if
                                missing)
      --json                    Return command outputs in json format
  -y, --yes
  -h, --help                    Print help
```
#### 查看目前的网络环境：`sui client envs`
示例：
```
 sui client envs
╭─────────────┬────────────────────────────────────┬────────╮
│ alias       │ url                                │ active │
├─────────────┼────────────────────────────────────┼────────┤
│ moveCTF2024 │ https://fullnode.devnet.sui.io:443 │ *      │
╰─────────────┴────────────────────────────────────┴────────╯
```
#### 获取钱包地址：`sui client addresses`
示例：
```
> sui client addresses
╭───────────────┬──────────────────────────────────────────────────────────────────────────╮
│ activeAddress │  0xcef64a585358ba722e0e1b860f11eb7e05eaf9347162ac6743c15cc0b60dd877      │
│ addresses     │ ╭──────────────────────────────────────────────────────────────────────╮ │
│               │ │  0xcef64a585358ba722e0e1b860f11eb7e05eaf9347162ac6743c15cc0b60dd877  │ │
│               │ ╰──────────────────────────────────────────────────────────────────────╯ │
╰───────────────┴──────────────────────────────────────────────────────────────────────────╯
```
#### 获取测试币：（我使用的是Windows Powershell进行操作，不能使用curl命令，win下使用Invoke-WebRequest命令代替curl。其他平台的我暂时没有测试，可以参考探姬师傅的教程）
```
$body = @{
    FixedAmountRequest = @{
        recipient = '你的钱包地址'
    }
} | ConvertTo-Json

Invoke-WebRequest -Uri 'https://faucet.devnet.sui.io/gas' -Method POST -Body $body -Headers @{
    'Content-Type' = 'application/json'
}
```
**注意钱包地址里不要有空格！！！**<br />（出现`Invoke-WebRequest : 基础连接已经关闭: 连接被意外关闭。`或`Invoke-WebRequest : error code: 1015`是因为未使用魔法或魔术回路不稳定。）<br />获取成功界面：
```
StatusCode        : 201
StatusDescription : Created
Content           : {"transferredGasObjects":[{"amount":10000000000,"id":"0x912044214a205f6963c7b27cc46a6785b9113c429d2
                    a050faae57f8d0087ff80","transferTxDigest":"G22f5qKc1aLFeVfPmE6to9zqZ4bhkAMHS5jDq6dEx8gw"}],"error":
                    nu...
RawContent        : HTTP/1.1 201 Created
                    Connection: keep-alive
                    Access-Control-Allow-Origin: *
                    Vary: origin,access-control-request-method,access-control-request-headers
                    CF-Cache-Status: DYNAMIC
                    Content-Length: 203
                    ...
Forms             : {}
Headers           : {[Connection, keep-alive], [Access-Control-Allow-Origin, *], [Vary, origin,access-control-request-m
                    ethod,access-control-request-headers], [CF-Cache-Status, DYNAMIC]...}
Images            : {}
InputFields       : {}
Links             : {}
ParsedHtml        : mshtml.HTMLDocumentClass
RawContentLength  : 203
```
#### 触发函数
语法：
```
Call Move function

Usage: sui client call [OPTIONS] --package <PACKAGE> --module <MODULE> --function <FUNCTION> --gas-budget <GAS_BUDGET>

Options:
    --package <PACKAGE>             Object ID of the package, which contains the module
    --module <MODULE>               The name of the module in the package
    --function <FUNCTION>           Function name in module
    --type-args <TYPE_ARGS>...      Type arguments to the generic function being called. All must be specified, or the call will fail
    --args <ARGS>...                Simplified ordered args like in the function syntax ObjectIDs, Addresses must be hex strings
    --gas <GAS>                     ID of the gas object for gas payment, in 20 bytes Hex string If not provided, a gas object with at least gas_budget value will be selected
    --gas-budget <GAS_BUDGET>       Gas budget for this call
    --serialize-unsigned-transaction  Instead of executing the transaction, serialize the bcs bytes of the unsigned transaction data (TransactionData) using base64 encoding, and print out
                                        the string
    --serialize-signed-transaction  Instead of executing the transaction, serialize the bcs bytes of the signed transaction data (SenderSignedData) using base64 encoding, and print out the
                                        string
    --json                          Return command outputs in json format
  -h, --help                            Print help
```
本题中需要触发get_flag函数<br />![屏幕截图 2023-12-29 160920.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703838321126-761033ca-8c9e-4add-b9cc-342490e14c3a.png#averageHue=%23504535&clientId=uef724c99-7fce-4&from=drop&id=uc4c9a6f4&originHeight=1323&originWidth=2048&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=191491&status=done&style=none&taskId=uc1c11a02-a59a-46d4-84f8-113a053afb7&title=)<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703838374670-d4f8daa4-0113-443e-bb90-2ec51d99e9b6.png#averageHue=%23fcfbfb&clientId=uef724c99-7fce-4&from=paste&height=795&id=u14aa5c4b&originHeight=1192&originWidth=1377&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=105537&status=done&style=none&taskId=ub8fd4387-8921-4b2d-98b4-07101e6d95b&title=&width=918)<br />这里获取到我们的packageId以构建触发函数：
```
> sui client call --function get_flag --package 0x01bbc5180d81f2fc4920ad602a6d9c0d447a85219c673eeee2a16a3b9bdf9d3f --module checkin --gas-budget 10000000

[warn] Client/Server api version mismatch, client api version : 1.15.1, server api version : 1.16.0
Transaction Digest: FcB7CsDCsW3mspcTB5nxtpJydbRXcLQRhm7HWdEJVN2f
╭──────────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Transaction Data                                                                                     │
├──────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Sender: 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f                           │
│ Gas Owner: 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f                        │
│ Gas Budget: 10000000 MIST                                                                            │
│ Gas Price: 1000 MIST                                                                                 │
│ Gas Payment:                                                                                         │
│  ┌──                                                                                                 │
│  │ ID: 0x144e80386b6bb8c5e2fe31fdf5299290e7b456c5782a1d11d98cd29e22e08acf                            │
│  │ Version: 110                                                                                      │
│  │ Digest: 7yra2w3ssVADaFrX3FzG9nsZ6b4XQfPPdz9T8ULJkUsV                                              │
│  └──                                                                                                 │
│                                                                                                      │
│ Transaction Kind : Programmable                                                                      │
│ Inputs: []                                                                                           │
│ Commands: [                                                                                          │
│   MoveCall(0x01bbc5180d81f2fc4920ad602a6d9c0d447a85219c673eeee2a16a3b9bdf9d3f::checkin::get_flag()), │
│ ]                                                                                                    │
│                                                                                                      │
│                                                                                                      │
│ Signatures:                                                                                          │
│    UysHNP76g5F0y3kGcje256HLSO9uZsxTXY9JmmLPml06KzvAg7dYj46ongZAbdMn1ZlT+CByx02TE3bniIHCDg==          │
│                                                                                                      │
╰──────────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Transaction Effects                                                                               │
├───────────────────────────────────────────────────────────────────────────────────────────────────┤
│ Digest: FcB7CsDCsW3mspcTB5nxtpJydbRXcLQRhm7HWdEJVN2f                                              │
│ Status: Success                                                                                   │
│ Executed Epoch: 2517                                                                              │
│                                                                                                   │
│ Mutated Objects:                                                                                  │
│  ┌──                                                                                              │
│  │ ID: 0x144e80386b6bb8c5e2fe31fdf5299290e7b456c5782a1d11d98cd29e22e08acf                         │
│  │ Owner: Account Address ( 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f )  │
│  │ Version: 111                                                                                   │
│  │ Digest: 6VR24FpTNg9eqYW8TuxiKQmeNENczLK91m8b3iV1sz5t                                           │
│  └──                                                                                              │
│                                                                                                   │
│ Gas Object:                                                                                       │
│  ┌──                                                                                              │
│  │ ID: 0x144e80386b6bb8c5e2fe31fdf5299290e7b456c5782a1d11d98cd29e22e08acf                         │
│  │ Owner: Account Address ( 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f )  │
│  │ Version: 111                                                                                   │
│  │ Digest: 6VR24FpTNg9eqYW8TuxiKQmeNENczLK91m8b3iV1sz5t                                           │
│  └──                                                                                              │
│                                                                                                   │
│ Gas Cost Summary:                                                                                 │
│    Storage Cost: 988000                                                                           │
│    Computation Cost: 1000000                                                                      │
│    Storage Rebate: 978120                                                                         │
│    Non-refundable Storage Fee: 9880                                                               │
│                                                                                                   │
│ Transaction Dependencies:                                                                         │
│    95186xqFzKTmDhUXWw5oxJw2Z4pxqdB6cPDA6aFidRPE                                                   │
│    AyE5rTMnhY4CmfDomoE5vh4TwWGhxdHcJdUPjtyTPE7x                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────╯
╭────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Transaction Block Events                                                                       │
├────────────────────────────────────────────────────────────────────────────────────────────────┤
│  ┌──                                                                                           │
│  │ EventID: FcB7CsDCsW3mspcTB5nxtpJydbRXcLQRhm7HWdEJVN2f:0                                     │
│  │ PackageID: 0x01bbc5180d81f2fc4920ad602a6d9c0d447a85219c673eeee2a16a3b9bdf9d3f               │
│  │ Transaction Module: checkin                                                                 │
│  │ Sender: 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f                  │
│  │ EventType: 0x1bbc5180d81f2fc4920ad602a6d9c0d447a85219c673eeee2a16a3b9bdf9d3f::checkin::Flag │
│  │ ParsedJSON:                                                                                 │
│  │   ┌──────┬────────────────────────────────────────────────────────────────────┐             │
│  │   │ flag │ true                                                               │             │
│  │   ├──────┼────────────────────────────────────────────────────────────────────┤             │
│  │   │ user │ 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f │             │
│  │   └──────┴────────────────────────────────────────────────────────────────────┘             │
│  └──                                                                                           │
╰────────────────────────────────────────────────────────────────────────────────────────────────╯
╭──────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Object Changes                                                                                   │
├──────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                  │
│ Mutated Objects:                                                                                 │
│  ┌──                                                                                             │
│  │ ObjectID: 0x144e80386b6bb8c5e2fe31fdf5299290e7b456c5782a1d11d98cd29e22e08acf                  │
│  │ Sender: 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f                    │
│  │ Owner: Account Address ( 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f ) │
│  │ ObjectType: 0x2::coin::Coin<0x2::sui::SUI>                                                    │
│  │ Version: 111                                                                                  │
│  │ Digest: 6VR24FpTNg9eqYW8TuxiKQmeNENczLK91m8b3iV1sz5t                                          │
│  └──                                                                                             │
╰──────────────────────────────────────────────────────────────────────────────────────────────────╯
╭───────────────────────────────────────────────────────────────────────────────────────────────────╮
│ Balance Changes                                                                                   │
├───────────────────────────────────────────────────────────────────────────────────────────────────┤
│  ┌──                                                                                              │
│  │ Owner: Account Address ( 0xf1a3394e4cfbc855ffcad1774b7505eff2d87659ad135a9fecf2755b1097bb8f )  │
│  │ CoinType: 0x2::sui::SUI                                                                        │
│  │ Amount: -1009880                                                                               │
│  └──                                                                                              │
│                                                                                                   │
╰───────────────────────────────────────────────────────────────────────────────────────────────────╯
```
我们的目标数据就是 `Transaction Digest: FcB7CsDCsW3mspcTB5nxtpJydbRXcLQRhm7HWdEJVN2f`（示例）<br />将冒号后的数据输入到题目Transaction后，可获得flag
#### 查看当前地址：`sui client active-address`

#### 列出当前地址拥有对象的摘要信息：`sui client objects` 
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703847756593-20715edc-1c11-40bc-ab8e-bd04e8740b2f.png#averageHue=%231c1c1c&clientId=u9b21307c-7848-4&from=paste&height=547&id=ue3b3b045&originHeight=821&originWidth=1410&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=101553&status=done&style=none&taskId=u97bdf181-b03b-4b79-873e-4a98d086ec4&title=&width=940)

#### 列出您提供的ID的对象信息：`sui client object <OBJECT-ID>`
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703847860638-fdcf3ea5-6834-4b09-b2c1-c995cd701f61.png#averageHue=%23141414&clientId=u9b21307c-7848-4&from=paste&height=641&id=u68b47598&originHeight=961&originWidth=1932&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=80999&status=done&style=none&taskId=uf5cde891-81f4-49ce-a544-1b77038281c&title=&width=1288)
#### Kali Linux测试（kali兼容性不太好……）
我采用二进制自动化构建失败，因此采取了docker安装的方式

- 启动sui：`docker exec -it suidevcontainer bash`
- 获取测试币：~~（失败）~~
- `curl --location --request POST '[https://faucet.devnet.sui.io/gas](https://faucet.devnet.sui.io/gas)' --header 'Content-Type: application/json' --data-raw '{ "FixedAmountRequest": { "recipient": "0x59903bc827e6a93e3d4c2f52e0707bca056076e82978993f8d56ad87e912b593" } }'`
### 二、安洵杯复现
#### mobilego

- 需要安装frida和objection插件进行调试（做题五分钟，装环境两小时[○･｀Д´･ ○]）

jadx分析：用关键字符串搜索找到主函数（用apk做测试用错误的提示字符串搜索更加容易想到）![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703860038000-31c14a0b-2f3c-45a4-b065-14152d988de7.png#averageHue=%23f4f3f1&clientId=u9b21307c-7848-4&from=paste&height=495&id=uc291abdf&originHeight=742&originWidth=1187&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=67739&status=done&style=none&taskId=uc493f949-5906-411d-b3a3-c4c45aee16a&title=&width=791.3333333333334)<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703860082066-aa3bb16c-3b69-4804-933c-8f41b84cd4ef.png#averageHue=%23fcfbfa&clientId=u9b21307c-7848-4&from=paste&height=181&id=u962e2460&originHeight=271&originWidth=1390&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=30181&status=done&style=none&taskId=u95fa60ef-493d-413b-8ae4-61704d324c0&title=&width=926.6666666666666)<br />大概是取了R.string.cmp中的数据，经过checkflag函数加密了<br />在资源文件中寻找![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703860182536-4b173ddf-5d2b-465f-a79c-e28e62cc33c2.png#averageHue=%23f4f4f3&clientId=u9b21307c-7848-4&from=paste&height=500&id=u80c536bc&originHeight=750&originWidth=1200&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=61393&status=done&style=none&taskId=u2570a973-85fb-454e-9737-1f47f14b54e&title=&width=800)<br />得到了疑似flag的数据  `49021}5f919038b440139g74b7Dc88330e5d{6` 应该是只是经过了顺序颠倒（但愿吧）<br />用frida下的objection在雷电模拟器里调试该程序![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703860356264-ba79387c-99a2-4617-9a8c-68a19be36abf.png#averageHue=%23ded7cf&clientId=u9b21307c-7848-4&from=paste&height=990&id=u8ea88b01&originHeight=1485&originWidth=2475&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=427345&status=done&style=none&taskId=u8841d6f5-b400-4b20-a41a-70e3323e247&title=&width=1650)

- objection hook的基本命令是：`android hooking watch class_method 方法名 [参数1类型名,参数2类型名...] [--dump-args] [--dump-return] [--dump-backtrace]`

这里hook checkflag 函数，在文件中输入一串不重复的数据
```
>objection -g mobilego explore
Using USB device `Android Emulator 5554`
Agent injected and responds ok!

     _   _         _   _
 ___| |_|_|___ ___| |_|_|___ ___
| . | . | | -_|  _|  _| | . |   |
|___|___| |___|___|_| |_|___|_|_|
      |___|(object)inject(ion) v1.11.0

     Runtime Mobile Exploration
        by: @leonjza from @sensepost

[tab] for command suggestions
com.example.mobilego on (OPPO: 9) [usb] #  android hooking watch class_method game.Game.checkflag --dump-return
(agent) Attempting to watch class game.Game and method checkflag.
(agent) Hooking game.Game.checkflag(java.lang.String)
(agent) Registering job 723570. Type: watch-method for: game.Game.checkflag
com.example.mobilego on (OPPO: 9) [usb] # (agent) [723570] Called game.Game.checkflag(java.lang.String)
(agent) [723570] Return Value: ViLdOlJTePKcMYZFQBSHUCXWIaAGkfbDghjNER
```
得到打乱后的形式，通过脚本模仿打乱方式，完成解密
```python
example="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijkl"
back="ViLdOlJTePKcMYZFQBSHUCXWIaAGkfbDghjNER"
crypto="49021}5f919038b440139g74b7Dc88330e5d{6"

for i in example:
    print(crypto[back.index(i)],end="")

   
```

- 恶补： index() 函数用于从列表中找出某个值第一个匹配项的索引位置。

                  语法：list.index(x[, start[, end]])<br />                  x-- 查找的对象。   start-- 可选，查找的起始位置。   end-- 可选，查找的结束位置。<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703860938184-9a601733-eb0c-4f50-af82-c088ebc14d42.png#averageHue=%23201e1c&clientId=u9b21307c-7848-4&from=paste&height=41&id=u688378ac&originHeight=61&originWidth=1462&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=21812&status=done&style=none&taskId=u40439ddd-8852-4046-a53a-dad5c6db888&title=&width=974.6666666666666)<br />可得D0g3{4c3b5903d11461f94478b7302980e958}

- **获得经验：可以先运行程序看看输出的字符串，然后到反编译软件里搜索输出的报错字符串位置，可以定位主函数！**
#### 你见过蓝色的小鲸鱼吗
无壳32位<br />没什么头绪，用findcryto查一下<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703900142217-4045fb7b-219f-4cd1-84d2-6e7955138268.png#averageHue=%23d5a764&clientId=u46fc36ba-a02c-4&from=paste&height=893&id=u858bbb19&originHeight=1339&originWidth=959&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=155382&status=done&style=none&taskId=uc9d0e9a4-2ae3-48ed-a25d-c647b3ace20&title=&width=639.3333333333334)<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703900178669-3952a8d9-fddd-4dd2-92c4-4a0a702fb30d.png#averageHue=%23f9f7f4&clientId=u46fc36ba-a02c-4&from=paste&height=112&id=ucb04ef97&originHeight=168&originWidth=1241&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=26531&status=done&style=none&taskId=u54c3a59b-27c1-465c-99ff-1806bbc9913&title=&width=827.3333333333334)<br />找一下位置![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703900205754-ac1d2c4e-c16b-4f98-b984-38c49823460a.png#averageHue=%23b5cf49&clientId=u46fc36ba-a02c-4&from=paste&height=326&id=u5af766a1&originHeight=489&originWidth=888&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=43627&status=done&style=none&taskId=udcbdaba2-08a5-4ded-9c94-aa372f19f66&title=&width=592)<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703900220302-a5f405d2-88d8-47f7-a6e2-7b548aa1fb41.png#averageHue=%23fcfcfc&clientId=u46fc36ba-a02c-4&from=paste&height=459&id=u6cbf99cc&originHeight=688&originWidth=1002&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=74063&status=done&style=none&taskId=u1ed7adc6-f1ee-4b2f-91f9-233b3b48c75&title=&width=668)<br />__CheckForDebuggerJustMyCode应该是个反调试，把它nop了![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703900339464-41be6b4e-005c-4595-9680-76bd1005c96d.png#averageHue=%23d7bf60&clientId=u46fc36ba-a02c-4&from=paste&height=682&id=u1b86538e&originHeight=1023&originWidth=1212&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=130955&status=done&style=none&taskId=u7a0bfc02-3d34-40b4-96fe-2375c94cdd1&title=&width=808)<br />X查一下交叉引用，看看父级函数什么样![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703900372485-475e0e64-356c-4f14-b1b6-5870420dbf93.png#averageHue=%23fdfdfd&clientId=u46fc36ba-a02c-4&from=paste&height=694&id=u04f50193&originHeight=1041&originWidth=1136&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=130944&status=done&style=none&taskId=u9256566a-2394-4dcd-91fc-abe966cd382&title=&width=757.3333333333334)<br />大概是获取了输入和长度，根据题目提示，IpString应该是账号，WindowTextLengthA应该是账号长度<br />猜测v4可能是密码，v8是密码长度，v2应该是内存地址之类的东西<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703900641477-5b38629e-5885-46c6-9f97-c9730df3f3c9.png#averageHue=%23e2dfdd&clientId=u46fc36ba-a02c-4&from=paste&height=207&id=u61a08de3&originHeight=310&originWidth=1414&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=71877&status=done&style=none&taskId=uf5009a92-ed91-40ae-8b40-0fc989b4705&title=&width=942.6666666666666)<br />37行进去![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703900416045-aee22f0f-2bdc-420c-b8e2-44b0bf756b68.png#averageHue=%23fcfcfc&clientId=u46fc36ba-a02c-4&from=paste&height=350&id=ud107786a&originHeight=525&originWidth=1044&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=57192&status=done&style=none&taskId=u11f1e3db-713a-46b7-b750-1210d611cfa&title=&width=696)<br />反调试函数nop掉<br />是一个判断函数，应该存在密文对比，猜测是前文获取了用户名，将用户名作为密钥blowfish加密了输入的密文，对比成功后输出正确<br />这里可以用动态调试把cmp过程中调取的用于对比的密文搞出来<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703901156729-ecd15793-e6a1-4910-a302-a5e9fa884e54.png#averageHue=%23439e40&clientId=u46fc36ba-a02c-4&from=paste&height=465&id=ud5104e85&originHeight=697&originWidth=1118&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=58702&status=done&style=none&taskId=u124fa30a-d228-4d2e-849a-ac568d9299d&title=&width=745.3333333333334)<br />调用cmp函数的位置下个断点<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703901202457-bf786c45-39c3-4aae-bab7-ea3b5a6d4bcd.png#averageHue=%23d6fafb&clientId=u46fc36ba-a02c-4&from=paste&height=419&id=u8a91a851&originHeight=628&originWidth=837&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=83892&status=done&style=none&taskId=u4595ced6-1657-4389-a3ad-4698911a991&title=&width=558)<br />数据就在call前面压栈的寄存器内![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703901233335-72d3aedc-b9d7-4e78-b8e7-672ecf3b84e8.png#averageHue=%2320201f&clientId=u46fc36ba-a02c-4&from=paste&height=460&id=u970b2576&originHeight=690&originWidth=174&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=19258&status=done&style=none&taskId=uf85805ec-3fcc-4fb6-a86b-22d080424e6&title=&width=116)取出来都补成两位<br />连起来就是密文 11A51F049550E2508F17E16CF1632B47<br />找个在线工具解密（CyberChef的密钥格式支持太少，很痛苦）<br />注意几个参数的设置<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703901411568-8f2aa150-2db3-4cae-861a-13e2cb87b13e.png#averageHue=%23e99a1f&clientId=u46fc36ba-a02c-4&from=paste&height=429&id=u21f78f1c&originHeight=644&originWidth=1581&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=62098&status=done&style=none&taskId=u479bf89c-abc7-4357-a3d5-5a00647753f&title=&width=1054)<br />拼接一下 D0g3{UzBtZTBuZV9EMGczQHRoZWJsdWVmMXNo}

- chen04师傅那里看到的详细解释：（我这里是猜的）![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704007549094-80927a8a-537c-4564-9a3b-894661f90abb.png#averageHue=%23d0cfce&clientId=u16208a59-15f9-4&from=paste&height=432&id=ua2059a3e&originHeight=648&originWidth=1044&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=222895&status=done&style=none&taskId=uf5fac4fe-c67b-4345-ac27-32300eb6013&title=&width=696)
#### 感觉有点点简单 
虽然不知道sys是什么东西，但是反正可以放进IDA分析<br />64位无壳，没有故意藏主函数<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703994047920-c3b5bdde-d649-491a-adfe-4ca4ca2fbc05.png#averageHue=%23fdfdfc&clientId=u15544a4b-a598-4&from=paste&height=678&id=ud2ba94ce&originHeight=1017&originWidth=986&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=132883&status=done&style=none&taskId=u3dcdf2bc-1d02-4a04-972b-84be6f110be&title=&width=657.3333333333334)<br />大致能看到在30、31行进行了加密<br />先是一个魔改RC4![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703994106947-e0d0c2db-1cd3-4f7d-b715-d4446ee821f1.png#averageHue=%23fdfcfc&clientId=u15544a4b-a598-4&from=paste&height=368&id=u06919333&originHeight=552&originWidth=963&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=56668&status=done&style=none&taskId=u8d68863d-b10b-4b0e-856c-bbd6273a4b7&title=&width=642)<br />循环的轮数改成了64，最后的异或也有些变化<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703994121732-2fbcfb54-56a7-4889-83b9-73ec3fe83d0d.png#averageHue=%23fdfdfc&clientId=u15544a4b-a598-4&from=paste&height=425&id=u2029ce97&originHeight=638&originWidth=990&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=69179&status=done&style=none&taskId=u0bfdc9a9-08ac-4adc-ac1a-ab3364fdc35&title=&width=660)<br />然后是魔改的base64<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704587393939-15718d8a-5cd6-4670-b4de-3642c455b510.png#averageHue=%23fdfdfd&clientId=ud5611a1b-73e7-4&from=paste&height=475&id=u4b0e9094&originHeight=713&originWidth=1543&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=92841&status=done&style=none&taskId=ubcdf4373-d462-412d-999d-6b87246988a&title=&width=1028.6666666666667)<br />与传统的base64算法不同，这里取二进制数值的时候有一些变化<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704587408176-92e4f977-9043-4dff-89df-2fb0f33d67ad.png#averageHue=%23e7e0cc&clientId=ud5611a1b-73e7-4&from=paste&height=234&id=u9d52a622&originHeight=351&originWidth=2223&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=15726&status=done&style=none&taskId=u2096cd83-4aa3-40d2-a598-9f36444f7ef&title=&width=1482)<br />都是三字符转四个字符，但是取的位数发生了如上图的变化<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703994317733-19b8cd39-f2db-4229-b04d-8f3bead4b6f4.png#averageHue=%23f7f7f6&clientId=u15544a4b-a598-4&from=paste&height=79&id=uf286a6ee&originHeight=118&originWidth=1250&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=14605&status=done&style=none&taskId=uf57b72d0-d41d-4f63-8f74-b0ddbcb52b7&title=&width=833.3333333333334)<br />=判断应该是base64魔改加密后的结果

根据以上分析构建脚本<br />先逆向出魔改base64的脚本，然后由于RC4是可逆的，魔改rc4基本上抄一遍IDA再跑一下就可以
```python
enc="6zviISn2McHsa4b108v29tbKMtQQXQHA+2+sTYLlg9v2Q2Pq8SP24Uw"
b64map="4KBbSzwWClkZ2gsr1qA+Qu0FtxOm6/iVcJHPY9GNp7EaRoDf8UvIjnL5MydTX3eh"
index=[b64map.index(i) for i in enc]+[0]
temp=[]
for i in range(0,len(index),4):  #b64将三个字符变成四个，逆向时每次截取4个字符，转化为三个原文
    get=index[i:i+4] #取4个字符，每个字符对应6位二进制
    temp.append(get[0]|((get[1]&0b11)<<6))
    temp.append((get[1]>>2)|((get[2]&0b1111)<<4))
    temp.append((get[2]>>4)|(get[3]<<2))

hex_list = [hex(num) for num in temp]  
print(hex_list)

#5c 21 7b 33 51 33 38 28 3a 2b 30 40 16 2c 33 25 36 4 38 46 51 3c 25 4a 13 33 39 3b 69 27 4d 29 33 14 33 46 30 31 32 40 6c 00
#RC4再跑一遍

key="the_key_"
S=[]
K=[]
for i in range(64):
    S.append(i)
for j in range(64):
    K.append(ord(key[j % len(key)]))
v6=0
for k in range(64):
    v6=(K[k]+S[k]+v6)%64
    S[k],S[v6]=S[v6],S[k]

v5=0
v6=0
for i in range(len(temp)):
    v5=(v5+1)%64
    v6=(S[v5]+v6)%64
    S[v5],S[v6]=S[v6],S[v5]
    temp[i]^=(v6^v5)&S[(((v6 ^ v5) + S[v6] + S[v5]) % 64)]
print("".join(map(chr,temp)))

```
运行后得到![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703994488999-1452e87d-ce07-4032-9d0d-7ad1b59809ea.png#averageHue=%2322211f&clientId=u15544a4b-a598-4&from=paste&height=67&id=uf3eb5848&originHeight=100&originWidth=1740&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=17695&status=done&style=none&taskId=u9c2b77e8-e9e7-4220-9739-9952e29e5c1&title=&width=1160)<br />D0g3{608292C4-15400BA4-B3299A5C-704C292D}
#### 牢大想你了
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704020790461-3fd53fc5-8851-41d3-a4f3-29fc9893ff45.png#averageHue=%23fbfaf9&clientId=uab3ed724-04d0-4&from=paste&height=259&id=u42efdd29&originHeight=388&originWidth=1045&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=34992&status=done&style=none&taskId=u10dea75d-c874-4f62-a485-f9a79460b1a&title=&width=696.6666666666666)<br />可以看到得到的是一个Unity文件<br />从Lazzaro师傅的blog里可以得到经验<br />[Unity逆向](https://lazzzaro.github.io/2020/12/13/reverse-Unity%E9%80%86%E5%90%91/index.html)
> **Unity Dll逆向**
> 一般的 Unity3D 游戏的主逻辑都在 Assembly-CSarp.dll 中，所以需要 dll文件逆向/重新打包 工具。Unity3D开发的游戏，其核心代码都在这个 dll 文件中，所以逆向/修改这个 dll 文件就可以了。

所以我们在文件夹里找 `Assembly-CSarp.dll` 这个文件<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704020999787-31912110-d3dd-42f5-b26c-f7bda13b1009.png#averageHue=%23fbfafa&clientId=uab3ed724-04d0-4&from=paste&height=483&id=ua931ff8e&originHeight=724&originWidth=1410&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=84274&status=done&style=none&taskId=ub0d99d35-53f0-4dfb-8785-741502f6d64&title=&width=940)<br />Unity框架的文件我们用dnspy进行反编译<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704021096990-bbc365e7-ce85-4096-84c3-219e8440eb2c.png#averageHue=%23262a2b&clientId=uab3ed724-04d0-4&from=paste&height=225&id=u878a9253&originHeight=338&originWidth=1013&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=31827&status=done&style=none&taskId=u39ac5fdc-5541-4f87-8b71-3ffb240a7ca&title=&width=675.3333333333334)<br />GameManager看起来像个正经文件，点开来看一下<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704021128169-be00fe25-2122-4e9b-84ee-fd029d0c381b.png#averageHue=%2322201f&clientId=uab3ed724-04d0-4&from=paste&height=942&id=ud2e0a470&originHeight=1413&originWidth=1472&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=142755&status=done&style=none&taskId=uc5163ef9-8f82-4ff1-b7a1-0ef7ef0d9bf&title=&width=981.3333333333334)<br />有“牢大”“flag”的字符串，应该是主函数部分<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704021169972-e5e008e0-e30f-43b0-b38b-ad2fe774650e.png#averageHue=%2321201e&clientId=uab3ed724-04d0-4&from=paste&height=841&id=u1ff1ff80&originHeight=1262&originWidth=1313&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=127629&status=done&style=none&taskId=u11521ab2-cd0d-4a8b-ab22-3c8c5b9d91f&title=&width=875.3333333333334)<br />往下翻看到类似key和密文的东西<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704021218491-579dca03-d6c6-4840-8360-65507bc1ae6c.png#averageHue=%23201f1e&clientId=uab3ed724-04d0-4&from=paste&height=221&id=u34ef3850&originHeight=332&originWidth=1259&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=27755&status=done&style=none&taskId=u7b257ce5-05e4-4836-9642-4fb8678d994&title=&width=839.3333333333334)<br />跟进一下encryptedData后面的字符串<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704021247273-53239f03-bc08-4bcc-8279-9ed1d289a954.png#averageHue=%23212020&clientId=uab3ed724-04d0-4&from=paste&height=335&id=u458d474b&originHeight=502&originWidth=1293&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=36502&status=done&style=none&taskId=u193f086a-9a72-403d-9651-54b97a782e5&title=&width=862)<br />跳转到加密函数位置，标准TEA加密<br />结合上文得知：密文={ 3363017039,1247970816,549943836,445086378,3606751618,1624361316,3112717362,705210466,3343515702,2402214294,4010321577,2743404694 }<br />密钥={ 286331153,286331153,286331153,286331153 }<br />delta=2654435769<br />由此构建TEA解密脚本
```c
#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>

void Decrypt(uint32_t* data, uint32_t* key)
{
    uint32_t v0 = data[0], v1 = data[1];
    uint32_t delta = 2654435769;
    uint32_t sum = delta * 32; //反过来最后一次的sum，循环32次

    for (int i = 0; i < 32; i++)
    {
        v1 -= ((v0 << 4) + key[2]) ^ (v0 + sum) ^ ((v0 >> 5) + key[3]);
        v0 -= ((v1 << 4) + key[0]) ^ (v1 + sum) ^ ((v1 >> 5) + key[1]);
        sum -= delta;
    }

    data[0] = v0;
    data[1] = v1;
} //解密函数

int main()
{
    uint32_t encryptedData[] = 
    { 3363017039,1247970816,549943836,445086378,
     3606751618,1624361316,3112717362,705210466,
     3343515702,2402214294,4010321577,2743404694 };  //12个
    uint32_t key[] = { 286331153,286331153,286331153,286331153 };

    for (int i = 0; i < 12; i += 2)   
    {
        Decrypt(&encryptedData[i], key);
    }

    printf("%s", encryptedData);

    return 0;
}
```
![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1704022342442-59fd2b52-d749-46fe-9dbe-fc138e709632.png#averageHue=%23101010&clientId=uab3ed724-04d0-4&from=paste&height=636&id=u08594df5&originHeight=954&originWidth=1730&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=46797&status=done&style=none&taskId=u34ba5815-3e23-45d3-b0e0-4cfe5c87d5c&title=&width=1153.3333333333333)<br />得到 flag{it_is_been_a_long_day_without_you_my_friend}
#### 你好，PE 
无壳32位<br />有大量的反调试函数__CheckForDebuggerJustMyCode，非常的恶心，手动删除很麻烦，可以搓一个脚本<br />学过C语言的都知道，被引用的函数是写在main函数外面的，需要的时候进行引用，所以该函数有一个固定的地址<br />这里的反调试函数也是一样，只要找到了其所在的地址，在每次引用这个地址时都把函数nop掉，就可以绕开反调试了<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704085562971-bbc9d13f-1907-4776-8187-da80ea020c18.png#averageHue=%23fdfdfd&clientId=ufa00bf0d-da7c-4&from=paste&height=356&id=GP8hI&originHeight=534&originWidth=900&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=46947&status=done&style=none&taskId=u5f0ef23c-a927-487d-8147-65b3c136d78&title=&width=600)<br />随便找一个反调试函数点开，注意在汇编窗口下查看地址<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704085631122-5942c773-04ab-46f4-89cd-ff2a3f5c505b.png#averageHue=%23f6f5e0&clientId=ufa00bf0d-da7c-4&from=paste&height=86&id=ua212ad78&originHeight=129&originWidth=1352&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=34209&status=done&style=none&taskId=u70bd5289-c7e6-4fcb-b913-0865f3c23b9&title=&width=901.3333333333334)![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704085639515-f60f0019-8331-4c69-86ea-23761c2f0659.png#averageHue=%23f8f7e7&clientId=ufa00bf0d-da7c-4&from=paste&height=161&id=u946f6dd2&originHeight=241&originWidth=1510&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=48175&status=done&style=none&taskId=u19c1de61-d1b6-46a2-86b2-245d85bdc92&title=&width=1006.6666666666666)<br />可以看到地址停留在00450C10，继续往下跟是内部的详细代码，不过我们只要把函数入口处地址找到就可以完成patch了
```python
#批量删除反调试函数
from ida_hexrays import *
from ida_dbg import *
from idaapi import *
from idautils import *
from idc import *
from ida_kernwin import *
'''交叉引用，获取引用0x0450C10（反调）处代码的地址列表'''
for item in CodeRefsTo(0x0450C10, 1):
    '''patch成0x90（nop）'''
    patch_bytes(item,bytes([90]*5))
```
![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704085767494-82e41436-ef44-4bad-956b-b57ec520457f.png#averageHue=%23eae9e7&clientId=ufa00bf0d-da7c-4&from=paste&height=219&id=u9b77e755&originHeight=328&originWidth=465&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=24391&status=done&style=none&taskId=ua06733a5-cdb2-4317-bd49-e97047c5626&title=&width=310)加载到ida运行，或者Script command写进去运行<br />运行完了没啥提示，别担心，已经运行成功了。（如果手撸一定要删完，不然调试会出问题）<br />然后寻找加密主函数<br />先静态分析往下跟<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704085877430-da65fe1a-f8e4-44d2-ab1a-e3a7b34fddf2.png#averageHue=%23fdfcfc&clientId=ufa00bf0d-da7c-4&from=paste&height=339&id=u296a34d5&originHeight=509&originWidth=804&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=42422&status=done&style=none&taskId=ufbc42795-99a6-408a-be5c-7231b7af6d4&title=&width=536)<br />注意12行sub_44E753第一个参数是0，第二个参数是疑似输入内容IpAddress，跟进去<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704085907069-4c2c8689-5b9c-4b0b-a96d-e2ecff57e4d5.png#averageHue=%23fbfbfb&clientId=ufa00bf0d-da7c-4&from=paste&height=238&id=u99cccd16&originHeight=357&originWidth=794&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=30059&status=done&style=none&taskId=u4157b113-3a20-4208-ad3c-a35dd7c8a22&title=&width=529.3333333333334)<br />这里只会触发case 0<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704086005436-fecf818e-773a-4044-8f6d-3d0b43f92ab8.png#averageHue=%23fcfcfc&clientId=ufa00bf0d-da7c-4&from=paste&height=708&id=ucccaeca2&originHeight=1062&originWidth=718&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=80889&status=done&style=none&taskId=u6bb154be-0c79-4427-8176-bfd6db4bfd2&title=&width=478.6666666666667)<br />这里上文a1是IpAddress，涉及到它的函数是sub_44FCC5<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704086054167-f7dbbaee-3530-4668-8c76-9ec2f06018d2.png#averageHue=%23fcfcfb&clientId=ufa00bf0d-da7c-4&from=paste&height=401&id=u42f60c76&originHeight=602&originWidth=675&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=57289&status=done&style=none&taskId=ufcbde673-e251-413f-87ba-4047bd5d01f&title=&width=450)<br />出现了IpAddress的大量引用，不知道哪个有用，动调尝试<br />会发现只有19行sub_44ED5C运行后会有字符串输出的变化<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704086148924-4279d734-641b-4b7f-8b72-ab42729c8d3f.png#averageHue=%23fcf3f3&clientId=ufa00bf0d-da7c-4&from=paste&height=369&id=u9bd2d4c9&originHeight=553&originWidth=834&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=46452&status=done&style=none&taskId=u1e0f4f99-491a-4710-81d5-fafc954721e&title=&width=556)<br />仔细调试会发现应该是在14行位置跳转至真·主函数<br />下个断点继续动调<br />F7进入，然后F8到这里停了，打个断点重启<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704086454820-4819e79c-8b08-416b-92ae-a59555206422.png#averageHue=%23b8bb6f&clientId=ufa00bf0d-da7c-4&from=paste&height=407&id=ubae6593d&originHeight=611&originWidth=2058&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=169121&status=done&style=none&taskId=u21e11513-5afc-446e-9753-ce58a28f121&title=&width=1372)<br />再来一次<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704086513364-acfb852d-2a41-4b7e-a3a9-14da67207311.png#averageHue=%23b3b560&clientId=ufa00bf0d-da7c-4&from=paste&height=285&id=ub0db8977&originHeight=428&originWidth=1962&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=110028&status=done&style=none&taskId=u8a05c61e-d848-4755-8936-8ae3429bd9f&title=&width=1308)<br />跑进主函数了<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704086555794-d33530c5-46f0-4912-afad-59a4456cf127.png#averageHue=%23aeba68&clientId=ufa00bf0d-da7c-4&from=paste&height=613&id=ub82cc583&originHeight=920&originWidth=2018&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=239641&status=done&style=none&taskId=u6e5af9f2-f117-45d5-ae1b-5a9b7a1faa0&title=&width=1345.3333333333333)<br />往上翻，在主函数开头部分按P形成函数，然后F5分析<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704092912698-21c9a788-71d6-4fa6-81bc-b814dc6428b9.png#averageHue=%23c7fcfd&clientId=ufa00bf0d-da7c-4&from=paste&height=501&id=uec4508d9&originHeight=752&originWidth=1780&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=118497&status=done&style=none&taskId=u9aa2eb4b-7b5d-4508-92b5-bc5f6739faa&title=&width=1186.6666666666667)<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704092958755-0d74494b-8a6f-4a99-8901-07fbbeeb62b1.png#averageHue=%23c8fcfd&clientId=ufa00bf0d-da7c-4&from=paste&height=529&id=u7689edbc&originHeight=793&originWidth=565&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=61014&status=done&style=none&taskId=u34293ff5-8f44-4ffd-b39e-76a14516340&title=&width=376.6666666666667)<br />通过len error的字样，我们可以猜测第一个if判断的是字符串长度，猜一下长度为41（紧接着41被改成48，根据答案格式可以猜测，增加的7个字符应当是 D0g3{}和'\0'，输入的仅仅是括号内的部分）<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704181975953-54a6837f-e046-4110-a940-f594cd5a2376.png#averageHue=%23b9b164&clientId=uc0040798-7262-4&from=paste&height=643&id=ue192ec25&originHeight=965&originWidth=2289&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=230219&status=done&style=none&taskId=ue08bfbd4-6080-4253-829b-178f3334a27&title=&width=1526)<br />我们也可以进17行确认一下<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704267778317-64723404-1612-4a1f-8e6f-592356ce2192.png#averageHue=%23c7fcfd&clientId=uc0040798-7262-4&from=paste&height=646&id=u98857d5d&originHeight=969&originWidth=1023&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=103928&status=done&style=none&taskId=uf811c25d-141e-4d5b-8427-6c22a02501c&title=&width=682)<br />显然是在计算flag长度<br />然后找一下加密函数<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704182068620-5f7d8d98-9699-42b2-a970-8a2ff9c8afa8.png#averageHue=%23c7fbfc&clientId=uc0040798-7262-4&from=paste&height=251&id=u1f8266c5&originHeight=377&originWidth=726&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=47460&status=done&style=none&taskId=uea27535f-7a5b-42e6-a8bf-36e211368ce&title=&width=484)<br />这里22行应该是字符串比较，unk_1013C008点进去就是密文（注意密文对比用了48个字符，从4D往下48个都是密文）<br />（1013C008）16+（48）10 =（1013 C038）16<br />整理一下可得密文：
```python
0x4D,0xB8,0x76,0x29,0xF5,0xA9,0x9E,0x59,
0x55,0x56,0xB1,0xC4,0x2F,0x21,0x2C,0x30,
0xB3,0x79,0x78,0x17,0xA8,0xED,0xF7,0xDB,
0xE1,0x53,0xF0,0xDB,0xE9,0x03,0x51,0x5E,
0x09,0xC1,0x00,0xDF,0xF0,0x96,0xFC,0xC1,
0xB5,0xE6,0x62,0x95,0x01,0x00,0x00,0x00,
```
![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704183671549-a9cb89d4-3b74-48d6-b203-74e009fc850e.png#averageHue=%23c9fcfc&clientId=uc0040798-7262-4&from=paste&height=490&id=u1246541e&originHeight=735&originWidth=967&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=105794&status=done&style=none&taskId=ue3988849-d584-4fc8-bde8-c442b849779&title=&width=644.6666666666666)<br />F8到21行F7进去<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704182092429-5211084e-d7a9-49e0-95a6-ef9836b39353.png#averageHue=%23c5fbfd&clientId=uc0040798-7262-4&from=paste&height=273&id=ua11297f1&originHeight=410&originWidth=1016&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=56590&status=done&style=none&taskId=u34e191fb-07f6-4757-a89d-6fcf2d0109b&title=&width=677.3333333333334)<br />照例P然后F5反编译（和官方跑出来不一样！**红温**了！8.3我也试过了，也不一样）<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704182180531-6fadce94-892d-4717-aec8-1e3661f8cd09.png#averageHue=%23c7fcfe&clientId=uc0040798-7262-4&from=paste&height=445&id=u3a235e72&originHeight=667&originWidth=804&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=46867&status=done&style=none&taskId=ue9c3982d-a3e4-4992-848e-c9984ca664b&title=&width=536)<br />qword_1013C000是一个被异或的部分，应该是某种密钥<br />![image.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704184647166-59ddee31-4fdc-48d7-9b43-9ba8141887f7.png#averageHue=%23bceff1&clientId=uc0040798-7262-4&from=paste&height=37&id=u76c4278b&originHeight=55&originWidth=361&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=4979&status=done&style=none&taskId=u35c9befa-915f-4a02-86b7-498ef04a9a1&title=&width=240.66666666666666)其值为54AA4A9<br />我这个伪代码和答案有出入，编不出来……拿官方的函数写脚本吧<br />![f79355f2b8a647a8a88fe5e4b375a2d5.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704186737657-a33043c3-9c1a-4eef-bf9f-f808d1b545b7.png#averageHue=%23c6fcfd&clientId=uc0040798-7262-4&from=paste&height=449&id=udad078d9&originHeight=673&originWidth=931&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=47179&status=done&style=none&taskId=uff6f99c2-b64c-4fac-bcca-2918e8e9961&title=&width=620.6666666666666)![c0c8b81d97fbd66d107d14d1f4357722.png](https://cdn.nlark.com/yuque/0/2024/png/40787854/1704186750641-abaff482-9fbf-4d1a-bcf3-cc210d09366a.png#averageHue=%23b1dcca&clientId=uc0040798-7262-4&from=paste&height=355&id=u884d9012&originHeight=532&originWidth=908&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=90188&status=done&style=none&taskId=udb6c3f5d-8de2-4a2d-83bd-fc725b843eb&title=&width=605.3333333333334)<br />抄一下官方的脚本进行分析
```c
#define _CRT_SECURE_NO_WARNINGS
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <Windows.h>

void fdec()
{
    __int64 dq_key = 88777897;  //用于异或的key(54AA4A9)
    BYTE flag[] = {
        0x4D,0xB8,0x76,0x29,0xF5,0xA9,0x9E,0x59,
        0x55,0x56,0xB1,0xC4,0x2F,0x21,0x2C,0x30,
        0xB3,0x79,0x78,0x17,0xA8,0xED,0xF7,0xDB,
        0xE1,0x53,0xF0,0xDB,0xE9,0x03,0x51,0x5E,
        0x09,0xC1,0x00,0xDF,0xF0,0x96,0xFC,0xC1,
        0xB5,0xE6,0x62,0x95,0x01,0x00,0x00,0x00,
    }; //密文
    __int64 p;
    int j, i;
    for (i = 0; i < 6; i++)  //48/8=6轮
    {
        p = *((__int64*)&flag[i * 8]); //每次取8位，形成一个块构成整数
        for (j = 0; j < 64; j++)  //64次加密
        {
            if (p & 1) //就是判断是否>0
            {
                p = ((unsigned __int64)p ^ dq_key) >> 1; //异或之后右移一位
                p |= 0x8000000000000000;//还原符号位1 

            }
            else
            {
                p = (unsigned __int64)p >> 1;  //直接右移一位
            }
        }
        *((__int64*)&flag[i * 8]) = p; //加密之后赋值回去
    }
    for (i = 0; i < 48; i++)  //全部打印出来
        printf("%c", flag[i]);
    printf("\n");
    return;
}

int main(int argc, BYTE* argv[])
{
    fdec();
    return 0;
}
```
~~devil师傅硬干汇编做出来了……我的汇编太烂了，写不出WP来~~
### 三、NCTF复现
#### 中文编程1
无壳32位<br />运行一下![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703861166034-77efe7a6-393c-47e7-8b0d-bd2a9c5836fc.png#averageHue=%231a1a1a&clientId=u9b21307c-7848-4&from=paste&height=73&id=u7b6021c0&originHeight=110&originWidth=579&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=9794&status=done&style=none&taskId=ubdb0a4eb-0bd3-4027-8c00-ace00a23316&title=&width=386)<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703861363731-d0484e37-a9f5-4099-a5c8-f8cf75ca94ec.png#averageHue=%23fdfcfb&clientId=u9b21307c-7848-4&from=paste&height=458&id=u7afa3181&originHeight=687&originWidth=1278&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=99871&status=done&style=none&taskId=u55d4b0a1-03e4-47a2-ba22-8894ed19d22&title=&width=852)<br />搜字符找不到函数<br />一步步动态调试找一下主函数<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703861450620-bf74f103-73f1-412b-9fcf-b5baf5ace965.png#averageHue=%23faf0ef&clientId=u9b21307c-7848-4&from=paste&height=379&id=uf63ab905&originHeight=569&originWidth=1481&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=79205&status=done&style=none&taskId=u1cfaeaff-b967-47ad-82f6-26586647b24&title=&width=987.3333333333334)<br />开头下个断点<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703861474397-ffea21e5-c02e-4d0e-9284-b7ab2e5db71c.png#averageHue=%23c8fdfe&clientId=u9b21307c-7848-4&from=paste&height=527&id=u9a555af3&originHeight=790&originWidth=982&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=99974&status=done&style=none&taskId=ub951dcb5-8c2f-4f8a-b313-6999bc3b3ef&title=&width=654.6666666666666)<br />走了两步发现主函数sub_40102B<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703861496275-8874f872-4f47-4a67-a849-43ab52432554.png#averageHue=%23cafdfd&clientId=u9b21307c-7848-4&from=paste&height=466&id=u97a949b1&originHeight=699&originWidth=537&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=67063&status=done&style=none&taskId=ue43a53b8-0dce-45b7-849b-4e477795f30&title=&width=358)<br />进去看一下大概是z3<br />![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703861522177-3f45746f-c480-4c45-8acd-712179cb9d48.png#averageHue=%23faf9f7&clientId=u9b21307c-7848-4&from=paste&height=755&id=u3e2ac612&originHeight=1132&originWidth=1411&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=268059&status=done&style=none&taskId=u356a9eb1-8eeb-4eec-941a-4d909347bc0&title=&width=940.6666666666666)<br />构建一下脚本**（复制的时候为了提高v20[i]编辑效率，可以选中“*v20 + ”部分右键“更改所有匹配项”把所有的都删了）**
```python
from z3 import *
from Crypto.Util.number import *

v20 = []  
for i in range(1, 13):  
    v20.append(Int('v20[' + str(i) + ']')) 

S = Solver()  #创建约束求解器

S.add(v20[1] * 52.0
     + v20[2] * 93.0
     + v20[3] * 15.0
     + v20[4] * 72.0
     + v20[5] * 61.0
     + v20[6] * 21.0
     + v20[7] * 83.0
     + v20[8] * 87.0
     + v20[9] * 75.0
     + v20[10] * 75.0
     + v20[11] * 88.0
     - 7.86241466532e11==0)  #添加约束条件
S.add(v20[1] * 24.0
     + v20[2] * 3.0
     + v20[3] * 22.0
     + v20[4] * 53.0
     + v20[5] * 2.0
     + v20[6] * 88.0
     + v20[7] * 30.0
     + v20[8] * 38.0
     + v20[9] * 2.0
     + v20[10] * 64.0
     + v20[11] * 60.0
     - 3.76271212978e11==0)
S.add(v20[1] * 21.0
     + v20[2] * 33.0
     + v20[3] * 76.0
     + v20[4] * 58.0
     + v20[5] * 22.0
     + v20[6] * 89.0
     + v20[7] * 49.0
     + v20[8] * 91.0
     + v20[9] * 59.0
     + v20[10] * 42.0
     + v20[11] * 92.0
     - 6.47642467922e11==0)
S.add(v20[1] * 60.0
     + v20[2] * 80.0
     + v20[3] * 15.0
     + v20[4] * 62.0
     + v20[5] * 62.0
     + v20[6] * 47.0
     + v20[7] * 62.0
     + v20[8] * 51.0
     + v20[9] * 55.0
     + v20[10] * 64.0
     + v20[11] * 3.0
     - 6.70839740597e11==0)
S.add(v20[1] * 51.0
     + v20[2] * 7.0
     + v20[3] * 21.0
     + v20[4] * 73.0
     + v20[5] * 39.0
     + v20[6] * 18.0
     + v20[7] * 4.0
     + v20[8] * 89.0
     + v20[9] * 60.0
     + v20[10] * 14.0
     + v20[11] * 9.0
     - 5.49200140865e11==0)
S.add(v20[1] * 90.0
     + v20[2] * 53.0
     + v20[3] * 2.0
     + v20[4] * 84.0
     + v20[5] * 92.0
     + v20[6] * 60.0
     + v20[7] * 71.0
     + v20[8] * 44.0
     + v20[9] * 8.0
     + v20[10] * 47.0
     + v20[11] * 35.0
     - 6.6473011328e11==0)

S.add(v20[1] * 78.0
     + v20[2] * 81.0
     + v20[3] * 36.0
     + v20[4] * 50.0
     + v20[5] * 4.0
     + v20[6] * 2.0
     + v20[7] * 6.0
     + v20[8] * 54.0
     + v20[9] * 4.0
     + v20[10] * 54.0
     + v20[11] * 93.0
     - 4.76762422687e11==0)

S.add(v20[1] * 63.0
     + v20[2] * 18.0
     + v20[3] * 90.0
     + v20[4] * 44.0
     + v20[5] * 34.0
     + v20[6] * 74.0
     + v20[7] * 62.0
     + v20[8] * 14.0
     + v20[9] * 95.0
     + v20[10] * 48.0
     + v20[11] * 15.0
     - 6.44352175854e11==0)

S.add(v20[1] * 72.0
      + v20[2] * 78.0
      + v20[3] * 87.0
      + v20[4] * 62.0
      + v20[5] * 40.0
      + v20[6] * 85.0
      + v20[7] * 80.0
      + v20[8] * 82.0
      + v20[9] * 53.0
      + v20[10] * 24.0
      + v20[11] * 26.0
      - 7.87224288556e11==0)

S.add(v20[1] * 89.0
      + v20[2] * 60.0
      + v20[3] * 41.0
      + v20[4] * 29.0
      + v20[5] * 15.0
      + v20[6] * 45.0
      + v20[7] * 65.0
      + v20[8] * 89.0
      + v20[9] * 71.0
      + v20[10] * 9.0
      + v20[11] * 88.0
      - 6.67891172792e11==0)

S.add(v20[1]
      + v20[2] * 8.0
      + v20[3] * 88.0
      + v20[4] * 63.0
      + v20[5] * 11.0
      + v20[6] * 81.0
      + v20[7] * 8.0
      + v20[8] * 35.0
      + v20[9] * 35.0
      + v20[10] * 33.0
      + v20[11] * 5.0
      - 4.17587420064e11==0)


S.check()  #检测是否有解

d=S.model() 

flag = b''  #字节字符串
for i in range(1,12):
     temp = long_to_bytes(d[v20[i]].as_long())
     temp = temp[::-1]
     flag += temp

print(flag)
```
直接输出会发现每四个字符都是倒过来的![image.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703894942594-e7839eb4-41bc-4370-ae6f-12ea1e1f225a.png#averageHue=%23201e1c&clientId=u46fc36ba-a02c-4&from=paste&height=77&id=u4d845f26&originHeight=115&originWidth=1632&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=45714&status=done&style=none&taskId=u686dfb81-d41f-4997-984d-93dfe4ed156&title=&width=1088)<br />所以加入一个temp逆序输出一下得到 flag{1517e135-aeac-412e-9fe4-91cd02c88290}
## 本周自己学习过程中遇到的问题和疑问点

- frida安装后无法正常使用![5105afc65a09fe5a946fcb55de0d6fc4.png](https://cdn.nlark.com/yuque/0/2023/png/40787854/1703854517731-68088dae-e260-4a17-886e-03cbb6de635b.png#averageHue=%23181818&clientId=u9b21307c-7848-4&from=paste&height=373&id=uc9376fda&originHeight=560&originWidth=1703&originalType=binary&ratio=1.5&rotation=0&showTitle=false&size=70520&status=done&style=none&taskId=ueb40e1e8-41a7-4b2d-ad58-818028c184f&title=&width=1135.3333333333333)

       无法查看版本号，似乎根本找不到软件位置。csdn上的解决方案都过时了，没有效果。<br />    ~~（重装后解决了，见了鬼了）~~

- 配置sui环境时物理机成功了，但是虚拟机kali\ubuntu都失败了，用了魔法都不行……
- 不会用windbg内核调试
- 你好PE那题IDA翻出来和官方不一样……可能是版本问题？（8.3也不行的）
## 情感、思考、观点
学海无涯，共同进步！
## 在团队的感触和建议
和师傅们在一起真的很温暖！

